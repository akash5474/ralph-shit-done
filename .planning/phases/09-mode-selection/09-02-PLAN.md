---
phase: 09-mode-selection
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - commands/gsd/help.md
  - commands/gsd/progress.md
  - commands/gsd/plan-phase.md
  - commands/gsd/execute-phase.md
  - commands/gsd/plan-milestone-all.md
autonomous: true

must_haves:
  truths:
    - "Help command shows both Interactive and Lazy command sets with mode labels"
    - "Progress command displays current mode in status output"
    - "Interactive-only commands error when invoked in lazy mode"
    - "Lazy-only commands error when invoked in interactive mode"
    - "Mode-restricted commands show clear error with suggestion to toggle mode"
  artifacts:
    - path: "commands/gsd/help.md"
      provides: "Command reference with mode labels and updated Workflow Modes section"
      contains: "(interactive)"
    - path: "commands/gsd/progress.md"
      provides: "Status display including current GSD mode"
      contains: "GSD_MODE"
    - path: "commands/gsd/plan-phase.md"
      provides: "Mode gate for interactive-only command"
      contains: "lazy"
    - path: "commands/gsd/execute-phase.md"
      provides: "Mode gate for interactive-only command"
      contains: "lazy"
    - path: "commands/gsd/plan-milestone-all.md"
      provides: "Mode gate for lazy-only command"
      contains: "interactive"
  key_links:
    - from: "commands/gsd/progress.md"
      to: ".planning/.ralph-config"
      via: "source config to read mode"
      pattern: "source.*ralph-config"
    - from: "commands/gsd/plan-phase.md"
      to: "bin/lib/mode.sh"
      via: "mode check pattern"
      pattern: "GSD_MODE"
    - from: "commands/gsd/help.md"
      to: "Workflow Modes section"
      via: "mode documentation"
      pattern: "Interactive Mode|Lazy Mode"
---

<objective>
Update GSD commands for mode awareness and display.

Purpose: With mode infrastructure in place (from Plan 01), commands need to respect mode restrictions and show mode-appropriate information. This completes the user-facing mode experience.

Output:
- Updated help.md with mode labels on commands
- Updated progress.md showing current mode
- Mode gating added to restricted commands
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-mode-selection/09-CONTEXT.md
@.planning/phases/09-mode-selection/09-RESEARCH.md
@.planning/phases/09-mode-selection/09-01-SUMMARY.md
@commands/gsd/help.md
@commands/gsd/progress.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update help.md with mode labels</name>
  <files>commands/gsd/help.md</files>
  <action>
Modify commands/gsd/help.md to add mode labels and update Workflow Modes section.

**Changes to make:**

1. **Add mode indicator note near top** (after Quick Start section):
```markdown
## Mode

GSD has two execution modes. Toggle with `/gsd:lazy-mode`.

| Mode | Workflow | Commands |
|------|----------|----------|
| Interactive | Plan one phase, execute, repeat | plan-phase, execute-phase |
| Lazy | Plan all upfront, run unattended | plan-milestone-all, run-milestone |

Check current mode with `/gsd:progress` or `/gsd:lazy-mode`.
```

2. **Add mode labels to commands** in existing sections:

Phase Planning section - label these as **(interactive)**:
- `/gsd:discuss-phase` (interactive)
- `/gsd:research-phase` (interactive)
- `/gsd:list-phase-assumptions` (interactive)
- `/gsd:plan-phase` (interactive)

Execution section - label these as **(interactive)**:
- `/gsd:execute-phase` (interactive)

Add new section after Execution for Lazy mode:
```markdown
### Lazy Mode Execution

**`/gsd:plan-milestone-all`** (lazy)
Generate all phase plans for entire milestone before autonomous execution.

**`/gsd:ralph`** (lazy)
Configure retry loop settings (max iterations, timeout).

**`/gsd:run-milestone`** (lazy)
Start autonomous execution. Runs until completion or cap reached.
```

3. **Update Workflow Modes section** (replace existing content):
```markdown
## Workflow Modes

**Interactive Mode**
- Plan one phase at a time with `/gsd:plan-phase`
- Execute with supervision via `/gsd:execute-phase`
- Iterate: plan → execute → plan → execute
- Human stays present during execution

**Lazy Mode**
- Plan ALL phases upfront with `/gsd:plan-milestone-all`
- Execute autonomously with `/gsd:run-milestone`
- "Fire and forget" — walk away after planning
- Human returns to completed work

Toggle between modes: `/gsd:lazy-mode`
```

4. **Update Common Workflows section** to show both:
```markdown
## Common Workflows

**Interactive: Starting a new project:**
```
/gsd:new-project
/clear
/gsd:plan-phase 1
/clear
/gsd:execute-phase 1
```

**Lazy: Fire and forget:**
```
/gsd:new-project
/gsd:lazy-mode              # Enable lazy mode
/gsd:plan-milestone-all     # Plan all phases
/gsd:ralph                  # Configure loop settings
/gsd:run-milestone          # Start autonomous execution
# ... walk away ...
```
```
  </action>
  <verify>
```bash
# Check for mode labels and sections
grep -q "(interactive)" commands/gsd/help.md && echo "Interactive labels: PASS"
grep -q "(lazy)" commands/gsd/help.md && echo "Lazy labels: PASS"
grep -q "plan-milestone-all" commands/gsd/help.md && echo "Lazy commands: PASS"
grep -q "Fire and forget" commands/gsd/help.md && echo "Workflow update: PASS"
grep -q "/gsd:lazy-mode" commands/gsd/help.md && echo "Toggle reference: PASS"
```
  </verify>
  <done>help.md has mode labels on commands, updated Workflow Modes section, both workflows documented</done>
</task>

<task type="auto">
  <name>Task 2: Update progress.md to show current mode</name>
  <files>commands/gsd/progress.md</files>
  <action>
Modify commands/gsd/progress.md to display current GSD mode in status output.

**Changes to make:**

1. **In step "load"**, add mode reading:
After "Read `.planning/PROJECT.md` for current state", add:
```markdown
- Read `.planning/.ralph-config` for GSD_MODE (if exists)
```

2. **In step "report"**, add mode display after "## Current Position":
```markdown
## Mode
[Interactive | Lazy | Not Set] — `/gsd:lazy-mode` to change
```

The display logic:
- If GSD_MODE="interactive" → show "Interactive"
- If GSD_MODE="lazy" → show "Lazy"
- If GSD_MODE unset or empty → show "Not Set"

3. **Add mode-aware routing hints** in Route B (Phase needs planning):

When mode is lazy, instead of suggesting `/gsd:plan-phase`, suggest:
```markdown
**If mode is lazy:**
`/gsd:plan-milestone-all` — plan all phases at once

**If mode is interactive or not set:**
`/gsd:discuss-phase {phase}` — gather context and clarify approach
```

This helps users who set lazy mode but haven't planned yet.
  </action>
  <verify>
```bash
# Check for mode display additions
grep -q "ralph-config" commands/gsd/progress.md && echo "Config read: PASS"
grep -q "GSD_MODE" commands/gsd/progress.md && echo "Mode variable: PASS"
grep -q "Not Set" commands/gsd/progress.md && echo "Unset display: PASS"
grep -q "lazy-mode" commands/gsd/progress.md && echo "Toggle hint: PASS"
```
  </verify>
  <done>progress.md reads and displays current mode, routes appropriately based on mode</done>
</task>

<task type="auto">
  <name>Task 3: Add mode gating to restricted commands</name>
  <files>commands/gsd/plan-phase.md, commands/gsd/execute-phase.md, commands/gsd/plan-milestone-all.md</files>
  <action>
Add mode validation to mode-restricted commands. Each gets a new step 0 at the start of their process.

**For commands/gsd/plan-phase.md** (interactive-only):

Add as first step in `<process>`:
```markdown
<step name="validate_mode">
**Validate Mode**

Check if running in lazy mode (where this command is disabled):

```bash
# Read current mode
source .planning/.ralph-config 2>/dev/null || true
CURRENT_MODE="${GSD_MODE:-}"

if [[ "$CURRENT_MODE" == "lazy" ]]; then
    echo ""
    echo "Error: /gsd:plan-phase is only available in Interactive mode."
    echo "Current mode: Lazy"
    echo ""
    echo "In Lazy mode, use /gsd:plan-milestone-all to plan all phases at once."
    echo "Run /gsd:lazy-mode to switch to Interactive mode."
    # Exit - do not continue
fi
```

If mode is "lazy", output the error and STOP. Do not proceed with planning.
</step>
```

**For commands/gsd/execute-phase.md** (interactive-only):

Add as first step in `<process>`:
```markdown
<step name="validate_mode">
**Validate Mode**

Check if running in lazy mode (where this command is disabled):

```bash
# Read current mode
source .planning/.ralph-config 2>/dev/null || true
CURRENT_MODE="${GSD_MODE:-}"

if [[ "$CURRENT_MODE" == "lazy" ]]; then
    echo ""
    echo "Error: /gsd:execute-phase is only available in Interactive mode."
    echo "Current mode: Lazy"
    echo ""
    echo "In Lazy mode, use /gsd:run-milestone for autonomous execution."
    echo "Run /gsd:lazy-mode to switch to Interactive mode."
    # Exit - do not continue
fi
```

If mode is "lazy", output the error and STOP. Do not proceed with execution.
</step>
```

**For commands/gsd/plan-milestone-all.md** (lazy-only):

Add as first step in `<process>`:
```markdown
<step name="validate_mode">
**Validate Mode**

Check if running in interactive mode (where this command is disabled):

```bash
# Read current mode
source .planning/.ralph-config 2>/dev/null || true
CURRENT_MODE="${GSD_MODE:-}"

if [[ "$CURRENT_MODE" == "interactive" ]]; then
    echo ""
    echo "Error: /gsd:plan-milestone-all is only available in Lazy mode."
    echo "Current mode: Interactive"
    echo ""
    echo "In Interactive mode, use /gsd:plan-phase to plan one phase at a time."
    echo "Run /gsd:lazy-mode to switch to Lazy mode."
    # Exit - do not continue
fi

# Also allow if mode not set (user can plan all even without mode selection)
```

If mode is "interactive", output the error and STOP. Do not proceed with planning.
Note: If mode is unset, allow the command (user may want to plan all regardless).
</step>
```

The pattern is consistent:
1. Source config file (with error suppression)
2. Read GSD_MODE variable
3. Check for disallowed mode
4. Output clear error with alternative command suggestion
5. STOP execution if wrong mode
  </action>
  <verify>
```bash
# Check each file has mode validation
grep -q "CURRENT_MODE" commands/gsd/plan-phase.md && echo "plan-phase gating: PASS"
grep -q "CURRENT_MODE" commands/gsd/execute-phase.md && echo "execute-phase gating: PASS"
grep -q "CURRENT_MODE" commands/gsd/plan-milestone-all.md && echo "plan-milestone-all gating: PASS"
# Check for helpful alternatives
grep -q "plan-milestone-all" commands/gsd/plan-phase.md && echo "Alternative in plan-phase: PASS"
grep -q "run-milestone" commands/gsd/execute-phase.md && echo "Alternative in execute-phase: PASS"
grep -q "plan-phase" commands/gsd/plan-milestone-all.md && echo "Alternative in plan-milestone-all: PASS"
```
  </verify>
  <done>Three commands have mode validation with clear errors and alternative suggestions</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Help shows mode info:**
```bash
grep "(interactive)" commands/gsd/help.md | head -3
grep "(lazy)" commands/gsd/help.md | head -3
```

2. **Progress reads mode:**
```bash
grep -A2 "## Mode" commands/gsd/progress.md
```

3. **Commands have gating:**
```bash
# Each should have mode check
for cmd in plan-phase execute-phase plan-milestone-all; do
    grep -q "GSD_MODE" commands/gsd/$cmd.md && echo "$cmd has mode check"
done
```

4. **Error messages are helpful:**
```bash
# Each restricted command suggests the alternative
grep "plan-milestone-all" commands/gsd/plan-phase.md
grep "run-milestone" commands/gsd/execute-phase.md
grep "plan-phase" commands/gsd/plan-milestone-all.md
```
</verification>

<success_criteria>
- [ ] help.md shows both command sets with (interactive)/(lazy) labels
- [ ] help.md has updated Workflow Modes section explaining both modes
- [ ] help.md Common Workflows shows both Interactive and Lazy examples
- [ ] progress.md reads mode from .ralph-config
- [ ] progress.md displays mode as "Interactive", "Lazy", or "Not Set"
- [ ] plan-phase.md has mode validation that blocks lazy mode
- [ ] execute-phase.md has mode validation that blocks lazy mode
- [ ] plan-milestone-all.md has mode validation that blocks interactive mode
- [ ] All mode errors include helpful alternative command suggestion
</success_criteria>

<output>
After completion, create `.planning/phases/09-mode-selection/09-02-SUMMARY.md`
</output>
