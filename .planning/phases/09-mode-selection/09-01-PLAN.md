---
phase: 09-mode-selection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/mode.sh
  - bin/lib/budget.sh
  - commands/gsd/lazy-mode.md
autonomous: true

must_haves:
  truths:
    - "Mode can be read from .ralph-config via get_mode function"
    - "Mode can be written to .ralph-config without losing other config values"
    - "User can toggle mode with /gsd:lazy-mode command"
    - "Mode toggle shows explainer about what changes in new mode"
    - "Warning appears when switching mode mid-milestone"
  artifacts:
    - path: "bin/lib/mode.sh"
      provides: "Mode read/write functions (get_mode, set_mode, is_mode, require_mode)"
      exports: ["get_mode", "set_mode", "is_mode", "require_mode"]
    - path: "bin/lib/budget.sh"
      provides: "Config persistence that preserves GSD_MODE field"
      contains: "GSD_MODE"
    - path: "commands/gsd/lazy-mode.md"
      provides: "Toggle command for switching between Interactive and Lazy modes"
      min_lines: 80
  key_links:
    - from: "commands/gsd/lazy-mode.md"
      to: ".planning/.ralph-config"
      via: "source and write pattern"
      pattern: "source.*ralph-config"
    - from: "bin/lib/mode.sh"
      to: ".planning/.ralph-config"
      via: "RALPH_CONFIG_FILE variable"
      pattern: "RALPH_CONFIG_FILE"
    - from: "bin/lib/budget.sh"
      to: "bin/lib/mode.sh"
      via: "shared config file"
      pattern: "GSD_MODE"
---

<objective>
Create mode infrastructure for Interactive vs Lazy mode selection.

Purpose: Enable users to choose their execution mode (Interactive for phase-by-phase work with human supervision, Lazy for fire-and-forget autonomous execution). This is the foundation for mode-restricted commands in Plan 02.

Output:
- bin/lib/mode.sh — library with mode read/write functions
- Extended budget.sh — preserves mode when saving other config
- commands/gsd/lazy-mode.md — toggle command with explainer
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-mode-selection/09-CONTEXT.md
@.planning/phases/09-mode-selection/09-RESEARCH.md
@bin/lib/budget.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mode.sh library</name>
  <files>bin/lib/mode.sh</files>
  <action>
Create new library bin/lib/mode.sh with these functions:

1. **get_mode()** — Return current GSD mode (interactive, lazy, or empty string if unset)
   - Source RALPH_CONFIG_FILE if exists
   - Echo GSD_MODE value (or empty if not set)

2. **set_mode(mode)** — Set GSD mode and save to config
   - Args: mode (interactive|lazy)
   - Load existing config first (preserve MAX_ITERATIONS, TIMEOUT_HOURS)
   - Set GSD_MODE
   - Write all values back to config file
   - Use same format as budget.sh (bash variable assignments with comment header)

3. **is_mode(expected)** — Check if current mode matches expected
   - Args: expected_mode
   - Returns: 0 if match, 1 if not

4. **require_mode(expected, command)** — Exit with error if mode doesn't match
   - Args: expected_mode, command_name
   - If mode empty: error "Mode not set. Run /gsd:lazy-mode first."
   - If mode doesn't match: error "{command} is only available in {expected} mode."
   - Return 1 on error, 0 on success

Use same RALPH_CONFIG_FILE pattern as budget.sh. Include standard bash header with description comments.
  </action>
  <verify>
```bash
# Source library and test functions
source bin/lib/mode.sh
# Test get_mode returns empty when no config
rm -f .planning/.ralph-config 2>/dev/null
[[ "$(get_mode)" == "" ]] && echo "get_mode empty: PASS"
# Test set_mode creates config
set_mode "lazy"
[[ "$(get_mode)" == "lazy" ]] && echo "set_mode/get_mode: PASS"
# Test is_mode
is_mode "lazy" && echo "is_mode match: PASS"
! is_mode "interactive" && echo "is_mode no-match: PASS"
```
  </verify>
  <done>mode.sh exists with all four functions, each function works correctly when tested</done>
</task>

<task type="auto">
  <name>Task 2: Extend budget.sh to preserve mode</name>
  <files>bin/lib/budget.sh</files>
  <action>
Modify save_config() function in bin/lib/budget.sh to preserve GSD_MODE when saving budget settings.

Current save_config writes only MAX_ITERATIONS and TIMEOUT_HOURS. Update to:
1. Before writing, source existing config to get current GSD_MODE value (if any)
2. Write all three values (MAX_ITERATIONS, TIMEOUT_HOURS, GSD_MODE) to config file
3. Only write GSD_MODE line if it has a value (not empty)

The pattern should be:
```bash
# In save_config():
# Load existing mode (if any)
local existing_mode=""
if [ -f "$RALPH_CONFIG_FILE" ]; then
    source "$RALPH_CONFIG_FILE"
    existing_mode="${GSD_MODE:-}"
fi

# Write config
cat > "$RALPH_CONFIG_FILE" << EOF
# GSD Ralph configuration
# Last updated: $(date)
MAX_ITERATIONS=$MAX_ITERATIONS
TIMEOUT_HOURS=$TIMEOUT_HOURS
EOF

# Append mode if set
if [ -n "$existing_mode" ]; then
    echo "GSD_MODE=$existing_mode" >> "$RALPH_CONFIG_FILE"
fi
```

This ensures budget changes don't wipe out mode setting.
  </action>
  <verify>
```bash
# Test: set mode, then change budget, verify mode preserved
source bin/lib/mode.sh
source bin/lib/budget.sh
set_mode "lazy"
MAX_ITERATIONS=100
TIMEOUT_HOURS=12
save_config
# Check mode still exists
grep "GSD_MODE=lazy" .planning/.ralph-config && echo "Mode preserved: PASS"
```
  </verify>
  <done>save_config preserves GSD_MODE field when saving budget settings</done>
</task>

<task type="auto">
  <name>Task 3: Create lazy-mode.md command</name>
  <files>commands/gsd/lazy-mode.md</files>
  <action>
Create new command commands/gsd/lazy-mode.md that toggles between Interactive and Lazy modes.

Frontmatter:
```yaml
---
name: gsd:lazy-mode
description: Toggle between Interactive and Lazy execution modes
allowed-tools:
  - Read
  - Write
  - Bash
---
```

Process:
1. Read current mode from .planning/.ralph-config (source it if exists)
2. Determine new mode:
   - If current is empty or "interactive" → set to "lazy"
   - If current is "lazy" → set to "interactive"
3. Check for active work (incomplete phases in ROADMAP.md)
   - If incomplete phases exist, show warning: "Warning: You have {N} incomplete phases. Switching modes mid-milestone may cause workflow issues."
4. Show mode explainer based on NEW mode:

   **If switching to Lazy:**
   ```
   ## Lazy Mode Enabled

   In Lazy mode, you plan everything upfront, then walk away.

   **What changes:**
   - Use `/gsd:plan-milestone-all` to generate ALL plans at once
   - Use `/gsd:run-milestone` for autonomous execution
   - Individual phase commands (plan-phase, execute-phase) are disabled

   **The workflow becomes:**
   new-project → plan-milestone-all → configure ralph → run-milestone → done

   Fire and forget. Wake up to completed work.
   ```

   **If switching to Interactive:**
   ```
   ## Interactive Mode Enabled

   In Interactive mode, you work phase-by-phase with Claude.

   **What changes:**
   - Use `/gsd:plan-phase` to plan one phase at a time
   - Use `/gsd:execute-phase` to execute with supervision
   - Lazy mode commands (plan-milestone-all, run-milestone) are disabled

   **The workflow becomes:**
   new-project → discuss-phase → plan-phase → execute-phase → repeat

   Collaborate with Claude on each phase.
   ```

5. Save mode to .ralph-config (preserve other values)
6. Confirm: "Mode set to: [Interactive|Lazy]. Run /gsd:lazy-mode again to toggle back."

Include success_criteria checklist at end.
  </action>
  <verify>
```bash
# Verify command file exists and has required sections
grep -q "name: gsd:lazy-mode" commands/gsd/lazy-mode.md && echo "Frontmatter: PASS"
grep -q "Lazy Mode Enabled" commands/gsd/lazy-mode.md && echo "Lazy explainer: PASS"
grep -q "Interactive Mode Enabled" commands/gsd/lazy-mode.md && echo "Interactive explainer: PASS"
grep -q "mid-milestone" commands/gsd/lazy-mode.md && echo "Warning text: PASS"
```
  </verify>
  <done>lazy-mode.md exists with toggle logic, mode explainers, and mid-milestone warning</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Library test:**
```bash
source bin/lib/mode.sh
source bin/lib/budget.sh

# Clean slate
rm -f .planning/.ralph-config

# Set mode
set_mode "lazy"
[[ "$(get_mode)" == "lazy" ]] && echo "Mode set: PASS"

# Change budget
MAX_ITERATIONS=75
TIMEOUT_HOURS=6
save_config

# Verify mode preserved
[[ "$(get_mode)" == "lazy" ]] && echo "Mode preserved after budget save: PASS"
```

2. **Command file exists:**
```bash
[ -f commands/gsd/lazy-mode.md ] && echo "Command file exists: PASS"
```

3. **Files have LF line endings:**
```bash
file bin/lib/mode.sh | grep -q "ASCII" && echo "mode.sh format: PASS"
```
</verification>

<success_criteria>
- [ ] bin/lib/mode.sh exists with get_mode, set_mode, is_mode, require_mode
- [ ] get_mode returns empty string when no config, "lazy" or "interactive" when set
- [ ] set_mode writes to .ralph-config without losing other values
- [ ] budget.sh save_config preserves GSD_MODE field
- [ ] commands/gsd/lazy-mode.md exists with complete toggle implementation
- [ ] lazy-mode.md includes explainers for both modes
- [ ] lazy-mode.md includes mid-milestone warning
- [ ] All files use LF line endings (per .gitattributes)
</success_criteria>

<output>
After completion, create `.planning/phases/09-mode-selection/09-01-SUMMARY.md`
</output>
