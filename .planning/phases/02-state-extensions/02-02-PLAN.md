---
phase: 02-state-extensions
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - bin/lib/state.sh
  - .planning/iteration-history.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Progress bar updates to reflect plans completed out of total"
    - "History older than 15 entries rolls to archive at phase boundaries"
    - "Archive file preserves full iteration history with phase boundary markers"
    - "Progress percentage is accurate (completed/total * 100)"
  artifacts:
    - path: "bin/lib/state.sh"
      provides: "Progress and history management functions"
      exports: ["generate_progress_bar", "update_progress", "rotate_history_at_phase_boundary", "get_plans_completed", "get_total_plans"]
      min_lines: 150
    - path: ".planning/iteration-history.md"
      provides: "Archive file for rolled-off history entries"
      contains: ["# Iteration History Archive"]
  key_links:
    - from: "bin/lib/state.sh:update_progress"
      to: ".planning/STATE.md"
      via: "sed replacement of Progress line"
      pattern: "Progress:.*\\[.*\\]"
    - from: "bin/lib/state.sh:rotate_history_at_phase_boundary"
      to: ".planning/iteration-history.md"
      via: "append archived entries"
      pattern: ">>.*iteration-history"
---

<objective>
Implement progress bar generation, history rolling window, and archive rotation.

Purpose: Keep STATE.md lean for fast fresh-instance loading while preserving full iteration history in archive. Progress bar gives visual feedback on milestone completion.

Output: Extended state.sh with progress/history functions and iteration-history.md archive file.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-state-extensions/02-CONTEXT.md
@.planning/phases/02-state-extensions/02-RESEARCH.md
@.planning/phases/02-state-extensions/02-01-SUMMARY.md

# Reference the state library from Plan 01
@bin/lib/state.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add progress bar functions to state.sh</name>
  <files>bin/lib/state.sh</files>
  <action>
Add the following functions to state.sh (append to existing file):

1. `generate_progress_bar completed total [width]` - Generate ASCII progress bar:
   - Default width: 30 characters
   - Format: `[##########                    ] 33%`
   - Use `#` for filled, space for empty
   - Handle edge case: if total is 0, return `[                              ] 0%`
   - Return via echo (caller captures with $())

2. `update_progress completed total` - Update Progress line in STATE.md:
   - Call generate_progress_bar to get the bar string
   - Use sed to replace the `Progress: [...]` line in STATE.md
   - Preserve the "Progress: " prefix

3. `get_plans_completed` - Count completed plans from ROADMAP.md:
   - Count lines matching `- [x]` pattern in phase Plans sections
   - Return count via echo

4. `get_total_plans` - Count total plans from ROADMAP.md:
   - Count lines matching `- [ ]` OR `- [x]` pattern in phase Plans sections
   - Return count via echo

Configuration constant:
```bash
PROGRESS_WIDTH=30
```

Edge cases to handle:
- 0/0 plans (empty roadmap) -> 0%
- 10/10 plans (fully complete) -> 100%
- Integer division rounding (15/26 = 57%, not 57.69%)
  </action>
  <verify>
Test progress bar generation:
```bash
source bin/lib/state.sh && \
  echo "0/10: $(generate_progress_bar 0 10)" && \
  echo "5/10: $(generate_progress_bar 5 10)" && \
  echo "10/10: $(generate_progress_bar 10 10)" && \
  echo "15/26: $(generate_progress_bar 15 26)"
```
Expected output shows bars with correct fill levels and percentages.
  </verify>
  <done>
Progress bar functions generate correct ASCII bars and can update STATE.md Progress line.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add history rolling and archive functions</name>
  <files>bin/lib/state.sh, .planning/iteration-history.md</files>
  <action>
Add history management functions to state.sh:

1. `get_history_entry_count` - Count entries in Iteration History:
   - Parse between HISTORY_START and HISTORY_END markers
   - Count lines matching `| [0-9]` pattern (entry rows, not header)
   - Return count via echo

2. `rotate_history_at_phase_boundary current_phase` - Archive old entries:
   - HISTORY_WINDOW=15 (configurable constant)
   - If entry count > HISTORY_WINDOW:
     - Extract oldest entries (beyond window)
     - Append to .planning/iteration-history.md with phase boundary header
     - Update STATE.md to keep only recent entries
   - If archive file doesn't exist, create it with header

3. Create `.planning/iteration-history.md` with initial content:
   ```markdown
   # Iteration History Archive

   Entries rolled off from STATE.md at phase boundaries.
   Git preserves full history; this file is for quick reference.

   ---
   ```

Configuration:
```bash
HISTORY_WINDOW=15
ARCHIVE_FILE="${ARCHIVE_FILE:-.planning/iteration-history.md}"
```

Archive entry format:
```markdown
## Phase {N} Boundary - YYYY-MM-DD HH:MM:SS

| # | Timestamp | Outcome | Task |
|---|-----------|---------|------|
| old entries here |
```
  </action>
  <verify>
Verify archive file created:
```bash
cat .planning/iteration-history.md
```
Should show header content.

Test history count function:
```bash
source bin/lib/state.sh && get_history_entry_count
```
Should return 0 or count of existing entries.
  </verify>
  <done>
History rolling functions exist and archive file is created with proper header.
  </done>
</task>

<task type="auto">
  <name>Task 3: End-to-end integration test</name>
  <files>bin/lib/state.sh, .planning/STATE.md</files>
  <action>
Verify the complete state management workflow:

1. Test progress update:
   - Call `update_progress 2 26` (Phase 1 complete = 2 plans of 26)
   - Verify STATE.md shows `Progress: [##                            ] 7%`

2. Test iteration entry + count:
   - Add 3 test entries with add_iteration_entry
   - Call get_history_entry_count, verify returns 3
   - Clean up test entries

3. Test that all functions from Plan 01 still work:
   - update_current_position
   - update_next_action
   - add_iteration_entry

4. Verify no syntax errors when sourcing:
   - `bash -n bin/lib/state.sh` should pass (syntax check)

5. Verify STATE.md integrity:
   - All markers still present
   - All sections properly formatted
   - File is valid markdown

After verification, clean up any test data and ensure STATE.md reflects actual current state (Phase 2, Plan 0, ready to execute).
  </action>
  <verify>
Run full verification:
```bash
bash -n bin/lib/state.sh && \
  source bin/lib/state.sh && \
  type generate_progress_bar && \
  type update_progress && \
  type rotate_history_at_phase_boundary && \
  echo "All functions verified"
```
  </verify>
  <done>
Complete state management system verified. All functions work correctly. STATE.md in clean state reflecting actual project position.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. state.sh has all progress and history functions (generate_progress_bar, update_progress, get_plans_completed, get_total_plans, get_history_entry_count, rotate_history_at_phase_boundary)
2. Progress bar generates correct ASCII visualization
3. History count works with empty and populated history
4. Archive file exists with proper header
5. All Plan 01 functions still work
6. No syntax errors in state.sh
</verification>

<success_criteria>
- [ ] generate_progress_bar produces correct ASCII bar for various inputs
- [ ] update_progress correctly modifies STATE.md Progress line
- [ ] get_history_entry_count returns accurate count
- [ ] rotate_history_at_phase_boundary function exists and handles empty case
- [ ] .planning/iteration-history.md exists with header
- [ ] bash -n bin/lib/state.sh passes (no syntax errors)
- [ ] All functions from Plan 01 still functional
- [ ] All changes committed to git
</success_criteria>

<output>
After completion, create `.planning/phases/02-state-extensions/02-02-SUMMARY.md`
</output>
