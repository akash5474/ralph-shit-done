---
phase: 07-learnings-propagation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/learnings.sh
autonomous: true

must_haves:
  truths:
    - "learnings.sh library provides functions to init, read, write, and prune AGENTS.md"
    - "Learnings are deduplicated before appending (exact match)"
    - "Section-based extraction returns relevant learnings for a given phase"
  artifacts:
    - path: "bin/lib/learnings.sh"
      provides: "Learning management functions"
      exports: ["init_agents_file", "get_learnings_for_phase", "append_learning", "extract_learnings_from_summary", "prune_agents_if_needed"]
  key_links:
    - from: "bin/lib/learnings.sh"
      to: ".planning/AGENTS.md"
      via: "sed section extraction"
      pattern: "sed -n '/^##.*Error Fixes/,/^##/"
---

<objective>
Create learnings.sh library with AGENTS.md management functions

Purpose: Provide the foundation for learning extraction, storage, and retrieval that enables patterns discovered during autonomous execution to be captured and consumed by future iterations.

Output: bin/lib/learnings.sh library with init, get, append, extract, and prune functions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-learnings-propagation/07-CONTEXT.md
@.planning/phases/07-learnings-propagation/07-RESEARCH.md

# Reference existing patterns
@bin/lib/state.sh
@bin/lib/recovery.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create learnings.sh with init and section-based loading</name>
  <files>bin/lib/learnings.sh</files>
  <action>
Create bin/lib/learnings.sh with these functions:

1. **init_agents_file()** - Create .planning/AGENTS.md with initial structure:
   ```markdown
   # Project Learnings

   Project-specific patterns discovered during autonomous execution.
   Auto-generated by ralph.sh - manual edits preserved.

   ## Error Fixes

   When you encounter specific errors, apply these fixes:

   ## Codebase Patterns

   Project conventions discovered during execution:

   ## Phase-Specific

   ```
   - Use atomic write pattern from state.sh (write to temp, then mv)
   - Create .planning directory if it doesn't exist

2. **get_learnings_for_phase(phase_num)** - Extract relevant sections:
   - Load "Error Fixes" section (always relevant)
   - Load "Codebase Patterns" section (always relevant)
   - Load "Phase-Specific > Phase {N}" subsection if exists
   - Use sed range patterns like recovery.sh's get_recent_failures
   - Return concatenated output to stdout
   - Return empty (exit 0) if no AGENTS.md exists yet (no learnings yet is OK)

Configuration:
- AGENTS_FILE="${AGENTS_FILE:-.planning/AGENTS.md}"
- Use NO_COLOR standard for any warnings

Follow patterns from state.sh and recovery.sh for sed-based section extraction.
  </action>
  <verify>
Manual verification:
1. Source the library: `source bin/lib/learnings.sh`
2. Run `init_agents_file` and confirm .planning/AGENTS.md created with correct structure
3. Run `get_learnings_for_phase 1` and confirm it returns empty without error
  </verify>
  <done>
- learnings.sh exists with init_agents_file and get_learnings_for_phase functions
- AGENTS.md structure matches spec (3 sections: Error Fixes, Codebase Patterns, Phase-Specific)
- Section loading handles missing file gracefully
  </done>
</task>

<task type="auto">
  <name>Task 2: Add append_learning with deduplication</name>
  <files>bin/lib/learnings.sh</files>
  <action>
Add to bin/lib/learnings.sh:

**append_learning(section, learning)** - Add learning if not already present:
- section: Target section name (e.g., "Error Fixes", "Codebase Patterns", "Phase 5")
- learning: The learning text to add (will be prefixed with "- ")
- Check if learning already exists using `grep -qF "$learning"` (exact match dedup)
- If already exists, return 0 silently (idempotent)
- If AGENTS.md doesn't exist, call init_agents_file first
- If target section doesn't exist, create it
- Use awk to insert after section header (like state.sh update_section pattern)
- Use temp file + mv for atomic write

For "Phase N" sections under Phase-Specific:
- Create as ### Phase N: (subsection) under ## Phase-Specific
- Pattern: if section starts with "Phase", create as subsection

Example usage:
```bash
append_learning "Error Fixes" "When permission denied on shell scripts, run chmod +x bin/*.sh"
append_learning "Phase 3" "Claude CLI uses -p flag for non-interactive mode"
```
  </action>
  <verify>
Manual verification:
1. Source library
2. Run `append_learning "Error Fixes" "Test learning 1"`
3. Run `append_learning "Error Fixes" "Test learning 1"` again (should be no-op)
4. Check AGENTS.md contains exactly one "Test learning 1" entry
5. Run `append_learning "Phase 7" "Phase-specific learning"`
6. Check AGENTS.md has "### Phase 7:" subsection under "## Phase-Specific"
  </verify>
  <done>
- append_learning function exists and handles section, learning arguments
- Exact-match deduplication prevents duplicates
- Creates section/subsection if missing
- Phase N learnings go under Phase-Specific as subsections
  </done>
</task>

<task type="auto">
  <name>Task 3: Add extract_learnings_from_summary and prune_agents_if_needed</name>
  <files>bin/lib/learnings.sh</files>
  <action>
Add to bin/lib/learnings.sh:

1. **extract_learnings_from_summary(summary_file, task_id)** - Parse SUMMARY.md frontmatter:
   - Extract `patterns-established` YAML array entries
   - Extract `key-decisions` YAML array entries
   - Parse task_id to get phase number (${task_id%%-*})
   - For each pattern: call append_learning "Phase {N}" "{pattern}"
   - For each decision: call append_learning "Codebase Patterns" "{decision}"
   - Return 0 if no summary file (nothing to extract is OK)
   - Use sed to extract YAML array items (pattern: /^patterns-established:/,/^[a-z]/)

2. **prune_agents_if_needed()** - Size management:
   - MAX_AGENTS_LINES=100 (warning threshold)
   - MAX_AGENTS_LINES_HARD=150 (hard cap)
   - If under MAX_AGENTS_LINES, return 0 silently
   - If between 100-150, log warning to stderr: "Warning: AGENTS.md has N lines (limit: 100)"
   - If over 150, truncate oldest entries from each section (keep first 10 per section)
   - Per CONTEXT.md: system manages entirely, users don't need to manually curate

Configuration constants at top of file:
```bash
MAX_AGENTS_LINES=100
MAX_AGENTS_LINES_HARD=150
```
  </action>
  <verify>
Create test SUMMARY.md with patterns-established and key-decisions:
```bash
cat > /tmp/test-summary.md << 'EOF'
---
patterns-established:
  - "Test pattern one"
  - "Test pattern two"
key-decisions:
  - "Test decision one"
---
# Summary
EOF
```
1. Run `extract_learnings_from_summary /tmp/test-summary.md 07-01`
2. Check AGENTS.md has Phase 7 subsection with patterns
3. Check AGENTS.md has Codebase Patterns section with decisions
4. Run prune_agents_if_needed - should return 0 (under limit)
  </verify>
  <done>
- extract_learnings_from_summary parses SUMMARY.md frontmatter and stores learnings
- prune_agents_if_needed enforces size limits
- Patterns go to phase-specific section, decisions go to Codebase Patterns
  </done>
</task>

</tasks>

<verification>
Final verification:
1. `source bin/lib/learnings.sh` - No syntax errors
2. `init_agents_file` creates well-structured AGENTS.md
3. `get_learnings_for_phase 7` returns relevant content
4. `append_learning` is idempotent (deduplication works)
5. `extract_learnings_from_summary` parses frontmatter correctly
6. All functions follow existing codebase patterns (atomic writes, sed extraction)
</verification>

<success_criteria>
- bin/lib/learnings.sh exists with all 5 functions
- Functions use patterns from state.sh and recovery.sh (atomic write, sed extraction)
- AGENTS.md structure has 3 main sections
- Deduplication prevents duplicate entries
- Size management warns at 100 lines, hard caps at 150
- All functions handle missing files gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/07-learnings-propagation/07-01-SUMMARY.md`
</output>
