---
phase: 01-safety-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/budget.sh
  - bin/lib/display.sh
autonomous: true

must_haves:
  truths:
    - "User can configure max iterations with editable default"
    - "User can configure timeout hours with editable default"
    - "Last-used values persist between runs"
    - "Invalid input is rejected with clear error message"
    - "Progress display shows iteration count, elapsed time, and remaining time"
  artifacts:
    - path: "bin/lib/budget.sh"
      provides: "Budget prompting and persistence"
      exports: ["load_config", "prompt_budget", "save_config", "validate_number"]
    - path: "bin/lib/display.sh"
      provides: "Terminal progress display"
      exports: ["show_progress", "format_duration"]
  key_links:
    - from: "bin/lib/budget.sh"
      to: ".planning/.ralph-config"
      via: "source and cat redirect"
      pattern: "source.*ralph-config|cat.*ralph-config"
---

<objective>
Create budget configuration infrastructure for ralph loop

Purpose: Enable users to set iteration limits and timeout before autonomous execution starts, with last-used values remembered for quick re-runs. This is the safety foundation that prevents runaway token burn.

Output: Two bash library files (budget.sh, display.sh) that ralph.sh will source in Phase 3.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-safety-foundation/01-CONTEXT.md
@.planning/phases/01-safety-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create budget prompting library</name>
  <files>bin/lib/budget.sh</files>
  <action>
Create bin/lib/budget.sh with these functions:

1. `load_config()` - Load from .planning/.ralph-config or use defaults (50 iterations, 8 hours)
   - Use `source` to load existing config
   - Apply defaults with `${VAR:-default}` pattern
   - Export MAX_ITERATIONS and TIMEOUT_HOURS

2. `validate_number()` - Validate input is positive integer
   - Args: value, field_name
   - Check regex `^[0-9]+$`
   - Check value >= 1
   - Return 1 on failure with colored error message

3. `prompt_budget()` - Interactive prompts with editable defaults
   - Call load_config first
   - Use `read -e -p "prompt" -i "$default"` for editable input
   - Loop until valid input for each field
   - Call save_config after both values confirmed

4. `save_config()` - Persist to .planning/.ralph-config
   - Create parent directory if needed
   - Write bash variable assignments (can be sourced)
   - Include timestamp comment

Use ANSI color codes for errors (RED) and success (GREEN).
Handle the case where .planning/ directory doesn't exist.

Do NOT use `read -e -i` if running non-interactively (check if stdin is a terminal with `[[ -t 0 ]]`).
  </action>
  <verify>
Source the file and test:
```bash
source bin/lib/budget.sh
validate_number "abc" "test" && echo "FAIL" || echo "PASS: rejected non-number"
validate_number "0" "test" && echo "FAIL" || echo "PASS: rejected zero"
validate_number "50" "test" && echo "PASS: accepted valid" || echo "FAIL"
```
  </verify>
  <done>
- load_config sets MAX_ITERATIONS and TIMEOUT_HOURS from file or defaults
- validate_number rejects non-numeric and zero values
- save_config writes sourceable config file
- prompt_budget loops until valid input (manual test)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create progress display library</name>
  <files>bin/lib/display.sh</files>
  <action>
Create bin/lib/display.sh with these functions:

1. `format_duration()` - Convert seconds to "Nh NNm" format
   - Args: seconds
   - Calculate hours and minutes
   - Use printf for zero-padded minutes

2. `show_progress()` - Display iteration status
   - Args: iteration, max_iterations, current_task, next_task (optional)
   - Calculate elapsed from START_TIME (global, set by caller)
   - Calculate remaining from TIMEOUT_HOURS (global)
   - Format: "Iteration N/M | Xh Ym elapsed | Xh Ym remaining"
   - Show completed task in green
   - Show next task in yellow (if provided)

3. `show_status()` - Show single-line status update
   - Args: message, type (info/success/error/warning)
   - Color based on type

Define color codes at top of file:
- RED='\e[31m'
- GREEN='\e[32m'
- YELLOW='\e[33m'
- CYAN='\e[36m'
- BOLD='\e[1m'
- RESET='\e[0m'

Ensure colors work on both Unix and Windows Git Bash (use \e not \033).
  </action>
  <verify>
Source and test:
```bash
source bin/lib/display.sh
format_duration 3665  # Should output "1h 01m"
format_duration 7200  # Should output "2h 00m"
show_status "Test message" "success"  # Should show green
show_status "Test error" "error"      # Should show red
```
  </verify>
  <done>
- format_duration correctly converts seconds to human-readable
- show_progress displays formatted iteration status
- show_status shows colored messages by type
- Colors render correctly in terminal
  </done>
</task>

<task type="auto">
  <name>Task 3: Create directory structure and verify integration</name>
  <files>bin/lib/budget.sh, bin/lib/display.sh</files>
  <action>
1. Ensure bin/lib/ directory exists
2. Add shebang and header comments to both files
3. Create a simple integration test:
   - Source both libraries
   - Test that functions don't conflict
   - Test that colors from display.sh are available in budget.sh context

Add to top of each file:
```bash
#!/bin/bash
# GSD Ralph - [Budget Configuration | Progress Display]
# Part of Phase 1: Safety Foundation
```

Verify both files are executable (chmod +x on Unix, or note Windows doesn't need it).
  </action>
  <verify>
```bash
# Integration test
source bin/lib/budget.sh
source bin/lib/display.sh
load_config
show_status "Config loaded: $MAX_ITERATIONS iterations, $TIMEOUT_HOURS hours" "info"
```
  </verify>
  <done>
- Both libraries source without error
- Functions from both are available
- No naming conflicts
- Directory structure exists: bin/lib/
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. File existence check:
```bash
ls -la bin/lib/budget.sh bin/lib/display.sh
```

2. Syntax check:
```bash
bash -n bin/lib/budget.sh && echo "budget.sh: OK"
bash -n bin/lib/display.sh && echo "display.sh: OK"
```

3. Function existence check:
```bash
source bin/lib/budget.sh
type load_config validate_number save_config prompt_budget

source bin/lib/display.sh
type format_duration show_progress show_status
```

4. Unit tests for validation:
```bash
source bin/lib/budget.sh
validate_number "50" "test" && echo "PASS" || echo "FAIL"
validate_number "abc" "test" && echo "FAIL - should reject" || echo "PASS"
validate_number "-1" "test" && echo "FAIL - should reject" || echo "PASS"
```
</verification>

<success_criteria>
- bin/lib/budget.sh exists with load_config, validate_number, save_config, prompt_budget functions
- bin/lib/display.sh exists with format_duration, show_progress, show_status functions
- Both files pass bash syntax check
- validate_number correctly rejects non-numeric input
- format_duration correctly formats seconds to "Nh Mm"
- Config persists to .planning/.ralph-config when save_config called
</success_criteria>

<output>
After completion, create `.planning/phases/01-safety-foundation/01-01-SUMMARY.md`
</output>
